---
title: "p8105_hw6_cac2225"
author: "Courtney Chan"
date: "November 26, 2018"
output: github_document
---

#Homework 6

##Problem 0
A github repo and local R project was created, an Rmd file was produced, knitted, and committed to github.

##Problem 1

First loading all necessary packages

```{r loading necessary packages}
library(tidyverse)


```

The csv file is imported using the read_csv function and the dataset is cleaned.

```{r}

homicide = read_csv("./data/homicide-data.csv") %>% 
  janitor::clean_names()

```


A city_state variable is created using the functions paste and mutate. Also a "solved" variable is created to indicate which cases have or have not been solved based on homework 5's prompt. The number of unsolved homicides is defined as those for which the disposition is “Closed without arrest” or “Open/No arrest”). City_states Dallas, TX, Pheonix, AZ, Kansas City, MO and Tulsa, AL are filtered out of the dataset.


```{r creating city_state variable, mutating solved, filtering city_state 2}

homicide = homicide %>% 
  mutate(city_state = str_c(city,", ",state)) %>% 
  mutate(solved = recode(disposition, "Closed without arrest" = "Unsolved", "Open/No arrest" = "Unsolved", "Closed by arrest" = "Solved")) %>% 
  filter(city_state != "Dallas, TX", city_state != "Phoenix, AZ", city_state != "Kansas City, MO", city_state != "Tulsa, AL")
  
```
The victim race variable is modified to be binary and for the catagory "White" to be defined as the reference catagory. Hispanic, Asian, Black, Other and Unknown were coded as "Non-white".

```{r modifying victim_race variable }

homicide = homicide %>% 
  mutate(victim_race = recode(victim_race, "Black" = "Non-white", "Hispanic" = "Non-white", "Asian" = "Non-white", "Other" = "Non-white", "Unknown" = "Non-white")) %>%  mutate(victim_race = factor(victim_race, levels = c("Non-white", "White")))

is.factor(homicide$victim_race)

```
Victim_age is first checked to see whether it is a numeric variable. Since it is not, the "unknown" category is first recoded as "NA". Then victim_age is defined as a numeric variable. It is checked again to see whether it was converted successfully into an numeric variable.

```{r victim_age}

is.numeric(homicide$victim_age)

homicide = homicide %>% 
 mutate(victim_age = as.numeric(victim_age)) %>% 
  mutate(factor(solved)) %>% 
  mutate(solved = factor(solved, levels = c("Solved", "Unsolved")))

is.numeric(homicide$victim_age)

is.factor(homicide$solved)

```

```{r baltimore analysis alone}

baltimore = homicide %>% 
  filter(city_state == "Baltimore, MD") %>% 
  glm(solved ~ victim_age +  victim_sex + victim_race, data = ., family = binomial())

baltimore %>% 
  broom::tidy() %>% 
  mutate(OR = exp(estimate)) %>% 
  mutate(conf.low = exp(estimate - (1.96*std.error)),
         conf.high = exp(estimate + (1.96*std.error))) %>% select(term, estimate, OR, conf.low, conf.high) %>% 
  filter(term == "victim_raceWhite")

```

For cases in Baltimore, MD, the point estimate describing the relationship between the outcome of solved homicides and the predictor victim race, adjusting for victim age and victim sex is 0.441, with a 95% confidence interval of 0.313 to 0.62.

For cases in Baltimate, MD, the odds of having a solved case amongst those who are non-white is 0.441 times the odds of having a solved case amongst those who are white, adjusting for victim age and sex. We are 95% confident that the true odds ratio lies between 0.313 and 0.62.

```{r applying glm to selected homicide df}

df_homicide = 
  homicide %>%
  group_by(city_state) %>% 
  nest() %>% 
  mutate(model = map(data, ~glm(solved ~ victim_age +  victim_sex + victim_race, data = ., family = binomial())), 
model = map(model, broom::tidy)) %>% 
  select(-data) %>% 
  unnest() %>% 
   mutate(OR = exp(estimate)) %>% 
  mutate(conf.low = exp(estimate - (1.96*std.error)),
         conf.high = exp(estimate + (1.96*std.error))) %>% select(city_state, term, estimate, OR, conf.low, conf.high) %>% 
  filter(term == "victim_raceWhite")


```

Glm is applied to each city_state and an OR with 95% confidence intervals is calculated for each city_state, comparing the odds of the case being solved, between non-whites and whites, adjusting for sex and age. 

```{r plot estimate ORs and CIs for each city}

df_homicide %>% 
  ggplot(aes(fct_reorder(city_state, desc(OR)), OR)) + geom_point() + geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) + theme(axis.text.x = element_text(angle = 90)) + ggtitle("estimated adjusted ORs and confidence intervals per city, state") + xlab("city, state") + ylab("adjusted estimate ORs of solved cases, non- vs whites")

```

##Problem 2

###Uploading the datafile, and dataset preparation/cleaning

The csv file is imported using the read_csv function and the dataset is cleaned.

```{r importing data}

birthweight = read_csv("./data/birthweight.csv") %>% 
  janitor::clean_names()

```

```{r looking at the variable type}
birthweight

```

According to the output, the variables are all integers. Looking at the data dictionary, variables that should be converted into factors should be baby sex, father's race, presence of malformations and mother's race.

```{r recoding variables and converting variables into factors}

birthweight = birthweight %>% 
  mutate(babysex = recode(babysex, "1" = "male", "2" = "female"),
         frace = recode(frace, "1" = "white", "2" = "black", "3" = "asian", "4" = "puerto rican", "8" = "other", "9" = "unknown"),
         mrace = recode(mrace, "1" = "white", "2" = "black", "3" = "asian", "4" = "puerto rican", "8" = "other"),
         malform = recode(malform, "0" = "absent", "1" = "present"))


birthweight = birthweight %>% 
  mutate(babysex = factor(babysex, levels = c("female", "male"))) %>% 
           mutate(malform = factor(malform, levels = c("present", "absent")))
         
birthweight = birthweight %>% 
         mutate(frace = factor(frace))

birthweight = birthweight %>% 
         mutate(mrace = factor(mrace))

is.factor(birthweight$babysex)
is.factor(birthweight$malform)
is.factor(birthweight$frace)
is.factor(birthweight$mrace)

```

Checking for missing data within the birthweight dataset.

```{r checking for missing data}

skimr::skim(birthweight)

```

Looking at the missing column for each variable, there are no missing values.

###Proposed model



###Comparison of model 
